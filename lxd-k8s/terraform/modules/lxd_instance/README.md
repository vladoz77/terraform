# Terraform модуль lxd_instance

Модуль для создания и управления LXD инстансами (виртуальными машинами или контейнерами) с поддержкой настройки ресурсов, дополнительных томов и облачной инициализации.

## Описание

Модуль `lxd_instance` автоматизирует процесс создания LXD инстансов на базе хост-машины. Он управляет:
- Созданием индивидуальных профилей LXD с настройками диска
- Созданием и подключением дополнительных томов
- Настройкой сетевых интерфейсов со статическими IP адресами
- Применением cloud-init конфигурации
- Проверкой доступности SSH после создания

## Возможности

✅ Создание профилей LXD с гибкой настройкой дисков  
✅ Поддержка виртуальных машин и контейнеров  
✅ Динамическое добавление дополнительных томов  
✅ Конфигурация сети с фиксированным IP  
✅ Автоматическая облачная инициализация  
✅ Проверка готовности инстанса (SSH)  
✅ Параллельное создание множества инстансов  

## Требования

- **Terraform**: >= 1.0
- **Провайдер**: terraform-lxd/lxd (версия >= 1.0)
- **LXD**: >= 5.0 с предварительно настроенным storage pool
- **Сеть**: Настроенная LXD сеть (например, lxdbr0)
- **Утилиты**: `nc` (netcat) для проверки SSH

## Входные переменные

### Обязательные

#### `network_name`
- **Тип**: `string`
- **Описание**: Имя LXD сети для подключения
- **Пример**: `"lxdbr0"`

#### `storage_pool`
- **Тип**: `string`
- **Описание**: Имя пула хранения для дополнительных томов
- **Пример**: `"default"`

#### `instance`
- **Тип**: `object`
- **Описание**: Конфигурация инстанса

Структура объекта `instance`:
```hcl
{
  name           = string  # Имя инстанса
  image          = string  # Образ LXD (например, "ubuntu:22.04")
  type           = string  # Тип: "virtual-machine" или "container"
  ipv4_address   = string  # Статический IPv4 адрес в сети
  cpu            = number  # Количество процессоров (например, 2)
  memory         = string  # Объем памяти (например, "4GB", "2048MB")
  cloud_init     = string  # Конфигурация cloud-init
  root_pool      = string  # Пул для корневого диска
  root_pool_size = string  # Размер корневого диска
}
```

### Опциональные

#### `volumes`
- **Тип**: `map(object({size = string}))`
- **По умолчанию**: `{}`
- **Описание**: Карта дополнительных томов

#### `wait_timeout`
- **Тип**: `number`
- **По умолчанию**: `300`
- **Описание**: Таймаут ожидания SSH в секундах

## Простой пример

```hcl
module "k8s_master" {
  source = "../modules/lxd_instance"

  network_name = "lxdbr0"
  storage_pool = "default"

  instance = {
    name           = "k8s-master-1"
    image          = "ubuntu:22.04"
    type           = "virtual-machine"
    ipv4_address   = "192.168.200.10"
    cpu            = 2
    memory         = "4GB"
    cloud_init     = file("${path.module}/cloud-init.yaml")
    root_pool      = "default"
    root_pool_size = "20GB"
  }

  wait_timeout = 300
}
```

## Отладка

### Инстанс не создается

```bash
# Проверьте доступность образа
lxc image list

# Проверьте сетевую конфигурацию
lxc network show lxdbr0
```

### SSH не доступен

```bash
# Проверьте статус инстанса
lxc list k8s-master-1

# Увеличьте таймаут
wait_timeout = 600
```

