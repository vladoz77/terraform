# üêâ Terraform LXD Instance Module

–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –≤ LXD —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CPU, –ø–∞–º—è—Ç–∏
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–æ–º–æ–≤ (storage volumes)
- Cloud-init
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö IP-–∞–¥—Ä–µ—Å–æ–≤

---

## ‚úÖ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- üß© –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω (`virtual-machine`)
- üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º IPv4
- üíæ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–º–æ–≤** —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—É—Ç—è–º–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚òÅÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `cloud-init` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –û–°
- üìè –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤: CPU, –ø–∞–º—è—Ç—å
- üîê –†–∞–±–æ—Ç–∞–µ—Ç —Å **self-signed –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º** `terraform-lxd/lxd`

---

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

| –ò–º—è | –í–µ—Ä—Å–∏—è |
|-----|--------|
| Terraform | >= 1.3 |
| LXD | >= 4.0 |
| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | `terraform-lxd/lxd ~> 2.5` |

---

## üß∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω

```hcl
# provider.tf
terraform {
  required_providers {
    lxd = {
      source  = "terraform-lxd/lxd"
      version = "~> 2.5"
    }
  }
}

provider "lxd" {
  generate_client_certificates = true
  accept_remote_certificate    = true
}
```

> ‚ö†Ô∏è –≠—Ç–æ **self-signed provider** ‚Äî HashiCorp –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –ø–æ–¥–ø–∏—Å—å.  
> –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç—ã –¥–æ–≤–µ—Ä—è–µ—à—å –∏—Å—Ç–æ—á–Ω–∏–∫—É.

---

### 2. –ò—Å–ø–æ–ª—å–∑—É–π –º–æ–¥—É–ª—å

```hcl
module "web-server" {
  source = "./modules/lxd-instance"

  network_name = "lxdbr0"

  instance = {
    name         = "web-01"
    image        = "ubuntu:22.04"
    cpu          = 2
    memory       = "2GB"
    ipv4_address = "192.168.200.10"
    profile      = "default"
    cloud_init   = file("${path.module}/cloud-init.yaml")
  }

  attached_volume = {
    data = {
      pool = "app-data"
      name = "data-web-01"
      path = "/mnt/data"
    }
    logs = {
      pool = "app-data"
      name = "logs-web-01"
      path = "/var/log/app"
    }
  }
}
```

---

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ò–º—è | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----|---------|-----|-------------|-------------|
| `network_name` | –ò–º—è LXD-—Å–µ—Ç–∏ (–º–æ—Å—Ç–∞) | `string` | –î–∞ | ‚Äî |
| `instance` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–∞ | `object` | –î–∞ | ‚Äî |
| `attached_volume` | –¢–æ–º–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | `map(object)` | –ù–µ—Ç | `{}` |

### `instance` (object)

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø |
|------|---------|-----|
| `name` | –ò–º—è –í–ú | `string` |
| `image` | –û–±—Ä–∞–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ubuntu:22.04`) | `string` |
| `cpu` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU | `number` |
| `memory` | –û–±—ä—ë–º –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"2GB"`) | `string` |
| `ipv4_address` | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IPv4 | `string` |
| `profile` | –ò–º—è –ø—Ä–æ—Ñ–∏–ª—è | `string` |
| `cloud_init` | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ `user-data` | `string` |

### `attached_volume` (map)

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|---------|
| `pool` | –ò–º—è storage pool |
| `name` | –ò–º—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–º–∞ |
| `path` | –ü—É—Ç—å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

> ‚ö†Ô∏è –¢–æ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—Å–æ–∑–¥–∞–Ω –∑–∞—Ä–∞–Ω–µ–µ** (–≤ –∫–æ—Ä–Ω–µ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ)

---

## üì§ Outputs

| –ò–º—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|---------|
| `vm_name` | –ò–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã |
| `vm_ipv4_address` | –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π IPv4-–∞–¥—Ä–µ—Å |
| `vm_mac_address` | MAC-–∞–¥—Ä–µ—Å –∏–Ω—Å—Ç–∞–Ω—Å–∞ |
| `vm_ipv6_address` | IPv6-–∞–¥—Ä–µ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å) |

---

## üõ† –ü—Ä–∏–º–µ—Ä—ã

### –°–æ–∑–¥–∞—Ç—å –í–ú —Å –æ–¥–Ω–∏–º —Ç–æ–º–æ–º

```hcl
module "db" {
  source = "./modules/lxd-instance"

  network_name = "lxdbr0"

  instance = {
    name   = "db-01"
    image  = "ubuntu:22.04"
    cpu    = 4
    memory = "4GB"
  }

  attached_volume = {
    data = {
      pool = "app-data"
      name = "data-db-01"
    }
  }
}
```

### –°–æ–∑–¥–∞—Ç—å –í–ú –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è

```hcl
instance = {
  name    = "standalone"
  # profile –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è default
}
```

---

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- ‚ùå **–¢–æ–º–∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –º–æ–¥—É–ª–µ** ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è
- ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `count`/`for_each`, –µ—Å–ª–∏ –≤ –º–æ–¥—É–ª–µ –µ—Å—Ç—å `lxd_volume`

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è LXD](https://documentation.ubuntu.com/lxd/)
- [Terraform LXD Provider](https://registry.terraform.io/providers/terraform-lxd/lxd/latest)

---

