# Terraform модуль lxd_network

Модуль создаёт и настраивает сеть LXD (bridge) — подключаемую сеть для инстансов модуля `lxd_instance`.

## Назначение

- Автоматизировать создание LXD bridge с подсетью IPv4 (и опционно IPv6)
- Настроить DHCP, NAT, DNS и маршрутизацию внутри LXD
- Предоставить понятный интерфейс для подключения инстансов из других модулей

## Возможности

- Создание LXD сети (bridge) с указанием подсети IPv4
- Включение/выключение NAT для выхода в интернет
- Настройка DHCP диапазона и статических адресов (через LXD или внешние настройки)
- Опциональная конфигурация IPv6
- Публикация имени сети для потребителей (модулей инстансов)

## Требования

- Terraform >= 1.0
- Провайдер `terraform-lxd/lxd` настроен и доступен
- Права на управление LXD на машине, где выполняется Terraform

## Входные переменные (типичные)

> Фактические переменные находятся в `variables.tf` модуля. Ниже — типичные поля, которые модуль поддерживает.

- `name` (string) — имя сети в LXD (например, `lxdbr0`)
- `ipv4_address` (string) — сеть в CIDR формате, используемая LXD (например, `192.168.200.1/24`)
- `ipv4_nat` (bool) — включить NAT для сети (по умолчанию `true`)
- `ipv4_dhcp_start` (string) — начальный адрес диапазона DHCP (например, `192.168.200.2`)
- `ipv4_dhcp_end` (string) — конечный адрес диапазона DHCP
- `ipv6_address` (string, optional) — CIDR IPv6 подсети
- `management` (object, optional) — дополнительные параметры (mtu, routes и т.д.)

Пример минимальных переменных в вызове:

```hcl
module "lxd_network" {
  source = "../modules/lxd_network"

  name         = "lxdbr0"
  ipv4_address = "192.168.200.1/24"
  ipv4_nat     = true
}
```

## Пример использования (с DHCP диапазоном)

```hcl
module "lxd_network" {
  source = "../modules/lxd_network"

  name             = "lxdbr0"
  ipv4_address     = "192.168.200.1/24"
  ipv4_nat         = true
  ipv4_dhcp_start  = "192.168.200.2"
  ipv4_dhcp_end    = "192.168.200.100"
}

module "instance" {
  source = "../modules/lxd_instance"
  network_name = module.lxd_network.network_name
  # ... остальные параметры
}
```

## Outputs (типичные)

- `network_name` — имя созданной LXD сети (для передачи в модуль `lxd_instance`)
- `ipv4_subnet` — CIDR IPv4 подсети
- `gateway` — адрес gateway внутри сети

## Рекомендации

- Если вы планируете использовать NAT, убедитесь, что хост, на котором запускается LXD, имеет настроенный доступ в интернет.
- Для production может быть разумно управлять DHCP и IP-адресами вне LXD (например, через внешний DHCP), чтобы избежать конфликтов.
- Проверяйте уникальность CIDR — повторное создание одинаковых подсетей может привести к конфликтам.

## Отладка

- Проверить созданную сеть:
  ```bash
  lxc network show lxdbr0
  ```
- Просмотреть список сетей:
  ```bash
  lxc network list
  ```
- Если инстансы не получают IP, проверьте настройки DHCP и диапазон адресов.
- Для логов LXD используйте системные журналы: `journalctl -u snap.lxd.daemon` или `sudo journalctl -u lxd` в зависимости от установки.

## Ограничения

- Модуль управляет только конфигурацией LXD network. Настройка внешней маршрутизации/маршрутов вне LXD выходит за рамки модуля.
- Трафик между сетями требует дополнительной настройки на хосте, если это нужно.

## Примеры дополнительных параметров

Если вам нужен нестандартный MTU, статические маршруты или дополнительные параметры, добавьте объект `management` в вызов модуля и пропишите нужные параметры в `main.tf` модуля.

## Советы по безопасности

- Не открывайте в публичный доступ подсети без необходимых правил NAT/фильтрации.
- Ограничьте доступ к LXD только доверенным пользователям/CI-агентам.

## Файлы модуля

```
lxd_network/
├── main.tf
├── variables.tf
├── outputs.tf
└── README.md
```


