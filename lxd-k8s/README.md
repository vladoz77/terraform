# LXD Kubernetes Terraform Project

Краткое описание
----------------
Этот проект содержит Terraform-конфигурацию для развёртывания инфраструктуры LXD, предназначенной для запуска кластеров Kubernetes (виртуальные машины / контейнеры). Инфраструктура включает storage pools, виртуальную сеть, инстансы и генерацию Ansible inventory.

Структура проекта
-----------------
- /terraform/infrastucture/main.tf — основная конфигурация (storage pools, network module, instance module, генерация inventory).
- /terraform/modules/lxd_network — модуль для создания LXD-сети.
- /terraform/modules/lxd_instance — модуль для создания инстансов LXD.
- cloud-init.yaml — шаблон cloud-init, применяется к инстансам.
- k8s-inventory.tftpl — шаблон для генерации файла inventory Ansible.
- ../../ansible/inventory.ini — сгенерированный инвентарь для Ansible (через resource local_file).

Используемые ресурсы
--------------------
- lxd_storage_pool — пул хранения (директории на хосте).
- Модуль lxd_network — LXD bridge (пример: lxdbr0, IPv4 сеть 192.168.200.0/24).
- Модуль lxd_instance — создание экземпляров (VM/контейнеры) с указанием CPU, памяти, дисков, cloud-init.
- local_file — генерация файла inventory для Ansible.

Предварительные требования
--------------------------
- Установлён LXD на хосте и настроен (snap/apt).
- Установлён Terraform (рекомендуется версия >= 1.0).
- Доступ к файловой системе для создания каталогов /mnt/lxd-pools/* или измените путь в конфигурации.
- (Опционально) Ansible для дальнейшего конфигурирования k8s-кластера.

Быстрая инструкция по запуску
-----------------------------
1. Клонировать репозиторий и перейти в папку с Terraform:
   - cd /path/to/terraform/infrastucture
2. Проверить и при необходимости изменить параметры:
   - storage pool source (путь в lxd_storage_pool)
   - локальные переменные instances (количество master/worker, CPU, memory, IP)
   - cloud-init.yaml (настройки SSH, пользователя и пр.)
3. Инициализировать Terraform:
   - terraform init
4. Просмотреть план:
   - terraform plan
5. Применить конфигурацию:
   - terraform apply
6. После успешного применения файл inventory будет сгенерирован в ../../ansible/inventory.ini и готов к использованию с Ansible.

Настройка и кастомизация
------------------------
- Измените local.instances в соответствующем файле (locals.tf / main.tf) чтобы добавить/удалить инстансы и задать ресурсы (cpu, memory, ipv4_address, volumes).
- Измените значения в modules/lxd_network для изменения имени сети и подсети.
- Обновите cloud-init.yaml для установки необходимых пакетов, ключей SSH и т.д.
- Для использования других образов (image) измените параметр image в модуле instance.

Безопасность и рекомендации
---------------------------
- Не храните секреты в коде Terraform (ssh-ключи, пароли). Используйте внешние провайдеры секретов или переменные окружения.
- Убедитесь, что права на каталоги /mnt/lxd-pools настроены корректно и безопасно.
- Тестируйте изменения в изолированной среде перед применением в продакшене.

Удаление инфраструктуры
-----------------------
- terraform destroy — удалит все ресурсы, управляемые конфигурацией.
- Удаление не затронет вручную созданные файлы вне состояния Terraform (проверьте каталоги pool-ов).

Полезные файлы
--------------
- cloud-init.yaml — шаблон для начальной настройки инстансов.
- k8s-inventory.tftpl — templatefile для генерации inventory.ini, используемого Ansible.

Лицензия
--------
Проект поставляется "как есть". При необходимости добавьте соответствующий файл LICENSE с выбранной лицензией.

Контакты и поддержка
--------------------
Использовать issue tracker репозитория для вопросов и предложений по улучшению конфигурации.