# üõ† Ansible Role: `traefik`

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç **Traefik v3.5** –∫–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π reverse-proxy –∏ edge router –¥–ª—è Docker-—Å—Ä–µ–¥—ã.  
–†–æ–ª—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Let's Encrypt, –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –≤ production-–æ–∫—Ä—É–∂–µ–Ω–∏–∏.

> ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è Jenkins, Nexus –∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö —á–µ—Ä–µ–∑ Docker.

---

## üîç –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–∞ —Ä–æ–ª—å:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–æ—Ä—Ç—ã `80` –∏ `443`, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –°–æ–∑–¥–∞—ë—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç Docker-—Å–µ—Ç—å—é
- –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç Traefik —á–µ—Ä–µ–∑ `docker-compose`
- –í–∫–ª—é—á–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥ —Å –∑–∞—â–∏—Ç–æ–π —á–µ—Ä–µ–∑ Basic Auth
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ CI/CD

---

## üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–ª–∏

```
roles/traefik/
‚îú‚îÄ‚îÄ defaults/
‚îÇ   ‚îî‚îÄ‚îÄ main.yaml          # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
‚îú‚îÄ‚îÄ meta/
‚îÇ   ‚îî‚îÄ‚îÄ main.yaml          # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îú‚îÄ‚îÄ install.yaml       # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ main.yaml          # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
‚îî‚îÄ‚îÄ templates/
    ‚îî‚îÄ‚îÄ docker-compose-traefik.yaml.j2  # —à–∞–±–ª–æ–Ω compose
```

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–§–∞–π–ª: `defaults/main.yaml`

```yaml
# Docker config
docker_network_name: "bridge"                             # –°–µ—Ç—å –¥–ª—è Traefik
traefik_container_name: "traefik"                         # –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
traefik_image: "traefik"                                  # –û–±—Ä–∞–∑
traefik_version: "v3.5"                                   # –í–µ—Ä—Å–∏—è
traefik_docker_dir: "/home/{{ ansible_user }}/{{ traefik_container_name }}"  # –ü—É—Ç—å –∫ compose
traefik_letsencrypt_path: "{{ traefik_docker_dir }}/letsencrypt"             # –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

# Dashboard config
traefik_enable_dashboard: true                            # –í–∫–ª—é—á–∏—Ç—å –¥–∞—à–±–æ—Ä–¥
traefik_dashboard_url: "{{ traefik_container_name }}.{{ domain_name }}"  # URL –¥–∞—à–±–æ—Ä–¥–∞
traefik_dashboard_user: "admin"                           # –õ–æ–≥–∏–Ω
traefik_dashboard_password_hash: "$$apr1$$CmiVRFjs$$bPQcSgQ.2HcTzM.HVTvAl1"  # –ü–∞—Ä–æ–ª—å: admin

# ACME / Let's Encrypt
domain_name: "yc.home-local.site"                         # –ë–∞–∑–æ–≤—ã–π –¥–æ–º–µ–Ω
acme_email: "vladoz77@yandex.ru"                          # Email –¥–ª—è Let's Encrypt
```

---

## üîê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

| –ß—Ç–æ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|-----|--------------|
| –ü–∞—Ä–æ–ª—å –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ | –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–≤–æ–π: `htpasswd -nBC 10 admin` |
| `bridge` —Å–µ—Ç—å | –ó–∞–º–µ–Ω–∏ –Ω–∞ `traefik-network` (—Å–º. –Ω–∏–∂–µ) |
| `acme_email` | –í—ã–Ω–µ—Å–∏ –≤ `group_vars` –∏–ª–∏ Ansible Vault |
| `insecure: true` | –£–±–µ—Ä–∏ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω API |

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –ø–ª–µ–π–±—É–∫–µ

```yaml
- hosts: jenkins-server
  become: yes
  roles:
    - role: traefik
      traefik_container_name: "traefik"
      domain_name: "yc.home-local.site"
```

### –° –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

```yaml
- name: Deploy Traefik
  ansible.builtin.include_role:
    name: traefik
  vars:
    traefik_container_name: "traefik-prod"
    acme_email: "admin@company.com"
    traefik_enable_dashboard: false
```

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–æ–ª—å

1. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç**, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `traefik`
2. **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç** –ª—é–±—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∑–∞–Ω–∏–º–∞—é—â–∏–µ –ø–æ—Ä—Ç—ã `80` –∏ `443`
3. **–°–æ–∑–¥–∞—ë—Ç —Å–µ—Ç—å**, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. **–°–æ–∑–¥–∞—ë—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é** –∏ –∫–æ–ø–∏—Ä—É–µ—Ç `docker-compose.yaml`
5. **–ó–∞–ø—É—Å–∫–∞–µ—Ç Traefik** —á–µ—Ä–µ–∑ `docker compose up`

> ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á–∏—Å—Ç—ã–π –∑–∞–ø—É—Å–∫ –¥–∞–∂–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–º–µ–Ω–∏ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

---

## üõ† –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Docker (—á–µ—Ä–µ–∑ —Ä–æ–ª—å `docker`)
- –ö–æ–ª–ª–µ–∫—Ü–∏—è: `community.docker`

```bash
ansible-galaxy collection install community.docker
```

–†–æ–ª—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `docker`:

```yaml
# meta/main.yaml
dependencies:
  - role: docker
```

---

## üåç –î–æ—Å—Ç—É–ø–Ω—ã–µ URL

| URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|--------|
| `https://traefik.yc.home-local.site` | –î–∞—à–±–æ—Ä–¥ Traefik (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω) |
| `http://<–≤–∞—à_—Ö–æ—Å—Ç>` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ HTTPS |
| `https://<–≤–∞—à_—Å–µ—Ä–≤–∏—Å>.yc.home-local.site` | –°–µ—Ä–≤–∏—Å—ã, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫ —Ç–æ–π –∂–µ —Å–µ—Ç–∏ –∏ —Å –ª–µ–π–±–ª–∞–º–∏ Traefik |

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
docker ps --filter name=traefik

# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã
ss -tulnp | grep ':80\|:443'

# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
docker logs traefik
```
