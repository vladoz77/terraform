# Инфраструктура Kubernetes в Yandex Cloud

Этот репозиторий содержит конфигурации Terraform для развертывания управляемого кластера Kubernetes в Yandex Cloud со всеми необходимыми сетевыми компонентами и группами безопасности.

## Обзор

Инфраструктура включает:
- Управляемый кластер Kubernetes в Yandex Cloud
- Группу рабочих узлов с прерываемыми виртуальными машинами
- Настройку сети и подсетей
- Комплексные группы безопасности для компонентов кластера
- Сервисный аккаунт с необходимыми разрешениями
- DNS-конфигурацию для сервисов
- Удаленное хранение состояния в Yandex Object Storage

## Требования

1. Аккаунт в Yandex Cloud с соответствующими разрешениями
2. Terraform версии 1.9.8 или новее
3. Провайдер yandex-cloud (v0.134.0)
4. Vault для управления секретами (опционально)
5. Настроенный SSH-ключ для доступа к узлам


### Ключевые компоненты

- **Кластер Kubernetes**:
  - Версия: 1.30 (настраиваемая)
  - Канал обновлений STABLE
  - Автообновление мастер-узлов

- **Группа узлов**:
  - Тип инстанса: standard-v2 (2 CPU, 4GB RAM)
  - Прерываемые инстансы для экономии
  - Сетевой HDD (64GB)
  - Среда выполнения Containerd

- **Сеть**:
  - CIDR кластера: 10.244.0.0/16
  - CIDR сервисов: 10.243.0.0/16
  - CIDR подсети: 172.16.20.0/24

- **Безопасность**:
  - Несколько групп безопасности для разных компонентов
  - Ограниченный SSH-доступ
  - Сервисный аккаунт с минимально необходимыми правами

## Развертывание

### Начальная настройка

1. Клонируйте репозиторий
2. Настройте бэкенд в `provider.tf`:
   ```terraform
   backend "s3" {
     endpoints = {
       s3 = "https://storage.yandexcloud.net"
     }
     bucket = "ваш-bucket-для-terraform-state"
     region = "ru-central1"
     key    = "kubernetes.tfstate"
   }
   ```

3. Установите необходимые переменные окружения:
   ```bash
   export YC_TOKEN="ваш_iam_токен"
   export YC_CLOUD_ID="ваш_cloud_id"
   export YC_FOLDER_ID="ваш_folder_id"
   export TF_VAR_ssh_key="$(cat ~/.ssh/id_rsa.pub)"
   ```

### Применение конфигурации

1. Инициализация Terraform:
   ```bash
   terraform init
   ```

2. Просмотр планируемых изменений:
   ```bash
   terraform plan
   ```

3. Применение конфигурации:
   ```bash
   terraform apply
   ```

## Настройка

### Переменные

Все настраиваемые параметры определены в `variables.tf`:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `cluster_name` | Имя кластера Kubernetes | `yandex-k8s` |
| `k8s_version` | Версия Kubernetes | `1.30` |
| `zone` | Зона Yandex Cloud | `ru-central1-a` |
| `username` | SSH-пользователь для узлов | `ubuntu` |
| `roles` | Роли сервисного аккаунта | См. variables.tf |

### Конфигурация группы узлов

Для изменения параметров отредактируйте `locals.tf`:
- Тип инстанса (platform_id)
- Ресурсы CPU/памяти
- Размер и тип диска
- Параметры масштабирования

## Доступ к кластеру

После развертывания настройте kubectl:
```bash
yc managed-kubernetes cluster get-credentials $(terraform output -raw cluster_id) --external
```

Проверьте доступ к кластеру:
```bash
kubectl get nodes
```

## Группы безопасности

Конфигурация включает несколько групп безопасности:

1. **k8s-cluster-nodegroup-traffic**: Правила для связи между узлами
2. **k8s-nodegroup-traffic**: Правила для связи между подами и сервисами
3. **k8s-services-access**: Внешний доступ к сервисам (диапазон NodePort)
4. **k8s-ssh-access**: SSH-доступ к узлам
5. **k8s-cluster-traffic**: Правила доступа к API-серверу

## Обслуживание

### Обновление Kubernetes

1. Обновите переменную `k8s_version`
2. Примените изменения:
   ```bash
   terraform apply
   ```

### Масштабирование узлов

Измените параметр `scale` в `locals.tf` и перепримените конфигурацию.

## Выходные данные

Конфигурация предоставляет следующие выходные данные:

- `cluster_id`: ID созданного кластера Kubernetes
- `external-ipv4`: Внешний IP мастер-узла
- `service-range`: Диапазон IP сервисов
- `ingress-static-ip`: Статический IP для ingress-контроллеров

## Очистка

Для удаления всех ресурсов:
```bash
terraform destroy
```

